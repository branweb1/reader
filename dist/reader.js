var SpeedOp,__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,c){function i(e){try{s(r.next(e))}catch(e){c(e)}}function a(e){try{s(r.throw(e))}catch(e){c(e)}}function s(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(i,a)}s((r=r.apply(e,t||[])).next())})};!function(e){e[e.Inc=0]="Inc",e[e.Dec=1]="Dec"}(SpeedOp||(SpeedOp={}));const RED_LETTER_OFFSET=5;let WPM=320,RUNNING=!1,WORDS=[],IDX=0;function calcRedIdx(e){let t;const n=e.length;return t=1===n?0:n<=3?1:n<8?2:3}function splitter(e){return concatMap(e=>e.split(/(\w+\-)/),e.split(/\s+/)).filter(idFunc)}function makeWord(e){const t=calcRedIdx(e);return leftpad(e.substring(0,t)," ",RED_LETTER_OFFSET-t)+`<span class="red-letter">${e.charAt(t)}</span>`+e.substring(t+1)}function calcSleepTime(e,t){let n=6e4/t;const r=e.slice(-1);return/[\.\!\;]/.test(r)?n+=230:/[\-\,\:]/.test(r)&&(n+=100),n}function concatMap(e,t){return t.reduce((t,n)=>[...t,...e(n)],[])}function idFunc(e){return e}function leftpad(e,t,n){let r="";for(let e=0;e<n;e++)r+=t;return r+e}function sleep(e){return new Promise(t=>setTimeout(t,e))}function extractTextArea(){const e=document.querySelector("textArea");return e?e.value:""}function extractTextAreaSelection(){const e=document.querySelector("textArea"),t=e.selectionStart,n=e.selectionEnd;return e?e.value.substring(t,n):""}function extractPageSelection(){return window.getSelection().toString()}function extractText(){const e=extractPageSelection();return e||(extractTextAreaSelection()||extractTextArea())}function setBarOffset(e){e.style.visibility="hidden",e.innerHTML=makeWord("dummyword");const t=e.querySelector("span").getBoundingClientRect().width,n=t/2+t*RED_LETTER_OFFSET;[...document.querySelector("#spritz-container").shadowRoot.querySelectorAll(".vert-bar")].forEach(e=>e.style.width=`${n}px`),e.innerHTML=" ",e.style.visibility="initial"}function modWPM(e){return t=>{t.preventDefault(),e===SpeedOp.Inc?WPM+=10:e===SpeedOp.Dec&&(WPM-=10),document.querySelector("#spritz-container").shadowRoot.querySelector(".wpm-count").textContent=`${WPM}`}}function cycleWords(e){return __awaiter(this,void 0,void 0,function*(){for(;IDX<WORDS.length&&RUNNING;){const t=makeWord(WORDS[IDX]);e.innerHTML=t,yield sleep(calcSleepTime(t,WPM)),IDX++}})}function keypressHandler(e){e.preventDefault()," "===e.key&&togglePause(e)}function readerSetup(){return __awaiter(this,void 0,void 0,function*(){const e=document.createElement("div");e.setAttribute("id","spritz-container"),e.attachShadow({mode:"open"});const t=yield fetch("https://branweb1.github.io/reader/dist/reader.html").then(e=>e.text()),n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href","https://branweb1.github.io/reader/dist/style.css"),e.shadowRoot.innerHTML=t,e.shadowRoot.insertBefore(n,e.shadowRoot.firstChild),document.body.appendChild(e),e.shadowRoot.querySelector(".close-btn").addEventListener("click",readerStop),e.shadowRoot.querySelector(".wpm-increase").addEventListener("click",modWPM(SpeedOp.Inc)),e.shadowRoot.querySelector(".wpm-decrease").addEventListener("click",modWPM(SpeedOp.Dec)),e.shadowRoot.querySelector(".pause").addEventListener("click",togglePause),e.shadowRoot.querySelector(".wpm-count").textContent=`${WPM}`,setBarOffset(e.shadowRoot.querySelector("#display-area"))})}function readerInit(){return __awaiter(this,void 0,void 0,function*(){let e=document.querySelector("#spritz-container");e?e.style.display="initial":(yield readerSetup(),e=document.querySelector("#spritz-container"));e.shadowRoot.querySelector("#display-area");const t=e.shadowRoot.querySelector(".container");document.addEventListener("keydown",keypressHandler),t.style.top=`${window.scrollY+45}px`,WORDS=splitter(extractText()),IDX=0})}function setPauseText(e){e.shadowRoot.querySelector(".pause").textContent=RUNNING?"pause":"start"}function togglePause(e){e.preventDefault(),RUNNING=!RUNNING;const t=document.querySelector("#spritz-container"),n=t.shadowRoot.querySelector("#display-area");setPauseText(t),cycleWords(n)}function readerStop(){const e=document.querySelector("#spritz-container");e.shadowRoot.querySelector("#display-area").textContent=" ",RUNNING=!1,setPauseText(e),document.removeEventListener("keydown",keypressHandler),WORDS=[],e.style.display="none"}