var SpeedOp,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};!function(SpeedOp){SpeedOp[SpeedOp.Inc=0]="Inc",SpeedOp[SpeedOp.Dec=1]="Dec"}(SpeedOp||(SpeedOp={}));const RED_LETTER_OFFSET=5;let WPM=320,VISIBLE=!1;function calcRedIdx(word){let redIdx;const wordlen=word.length;return redIdx=1===wordlen?0:wordlen<=3?1:wordlen<8?2:3}function splitter(text){return concatMap(a=>a.split(/(\w+\-)/),text.split(/\s+/)).filter(idFunc)}function makeWord(word){const idx=calcRedIdx(word);return leftpad(word.substring(0,idx)," ",RED_LETTER_OFFSET-idx)+`<span class="red-letter">${word.charAt(idx)}</span>`+word.substring(idx+1)}function calcSleepTime(word,wpm){let base=6e4/wpm;const lastChar=word.slice(-1);return/[\.\!\;]/.test(lastChar)?base+=230:/[\-\,\:]/.test(lastChar)&&(base+=100),base}function concatMap(f,arr){return arr.reduce((acc,a)=>[...acc,...f(a)],[])}function idFunc(a){return a}function leftpad(word,char,n){let padding="";for(let i=0;i<n;i++)padding+=char;return padding+word}function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}function extractTextArea(){const txtarea=document.querySelector("textArea");return txtarea?txtarea.value:""}function extractTextAreaSelection(){const txtarea=document.querySelector("textArea"),start=txtarea.selectionStart,finish=txtarea.selectionEnd;return txtarea?txtarea.value.substring(start,finish):""}function extractPageSelection(){return window.getSelection().toString()}function extractText(){const pageSel=extractPageSelection();return pageSel||(extractTextAreaSelection()||extractTextArea())}function setBarOffset(elem){elem.style.visibility="hidden",elem.innerHTML=makeWord("dummyword");const charLen=elem.querySelector("span").getBoundingClientRect().width,offset=charLen/2+charLen*RED_LETTER_OFFSET;[...document.querySelector("#spritz-container").shadowRoot.querySelectorAll(".vert-bar")].forEach(node=>node.style.width=`${offset}px`),elem.innerHTML=" ",elem.style.visibility="initial"}function modWPM(op){return e=>{e.preventDefault(),op===SpeedOp.Inc?WPM+=10:op===SpeedOp.Dec&&(WPM-=10),document.querySelector("#spritz-container").shadowRoot.querySelector(".wpm-count").textContent=`${WPM}`}}function cycleWords(words,display){return __awaiter(this,void 0,void 0,function*(){for(let i=0;i<words.length&&VISIBLE;i++){const word=makeWord(words[i]);display.innerHTML=word,yield sleep(calcSleepTime(word,WPM))}})}function readerStop(){const container=document.querySelector("#spritz-container");VISIBLE=!1,container.style.display="none"}function readerSetup(){return __awaiter(this,void 0,void 0,function*(){const div=document.createElement("div");div.setAttribute("id","spritz-container"),div.attachShadow({mode:"open"});const html=yield fetch("https://branweb1.github.io/reader/dist/reader.html").then(resp=>resp.text()),style=document.createElement("link");style.setAttribute("rel","stylesheet"),style.setAttribute("type","text/css"),style.setAttribute("href","https://branweb1.github.io/reader/dist/style.css"),div.shadowRoot.innerHTML=html,div.shadowRoot.insertBefore(style,div.shadowRoot.firstChild),document.body.appendChild(div),div.shadowRoot.querySelector(".close-btn").addEventListener("click",readerStop),div.shadowRoot.querySelector(".wpm-increase").addEventListener("click",modWPM(SpeedOp.Inc)),div.shadowRoot.querySelector(".wpm-decrease").addEventListener("click",modWPM(SpeedOp.Dec)),div.shadowRoot.querySelector(".wpm-count").textContent=`${WPM}`,setBarOffset(div.shadowRoot.querySelector("#display-area"))})}function readerInit(){return __awaiter(this,void 0,void 0,function*(){let exists=document.querySelector("#spritz-container");exists?exists.style.display="initial":(yield readerSetup(),exists=document.querySelector("#spritz-container"));const display=exists.shadowRoot.querySelector("#display-area");exists.shadowRoot.querySelector(".container").style.top=`${window.scrollY+45}px`,VISIBLE=!0,cycleWords(splitter(extractText()),display)})}